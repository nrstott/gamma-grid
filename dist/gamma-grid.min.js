/*! gamma-grid - v0.3.0 - 2016-12-12
* Copyright (c) 2016 ; Licensed  */
!function(a){a.fn.gammaGrid=function(b,c){function d(a){var b="";for(var c in a)c&&(b+=encodeURIComponent(c)+"="+encodeURIComponent(a[c])+"&");return b.lastIndexOf("&")==b.length-1&&(b=b.substring(0,b.length-1)),b}function e(a){0===a.indexOf("?")&&(a=a.substring(1));for(var b={},c=a.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");b[decodeURIComponent(e[0])]=decodeURIComponent(e[1])}return b}Object.keys||(Object.keys=function(a){var b,c=[];for(b in a)Object.prototype.hasOwnProperty.call(a,b)&&c.push(b);return c});var f=this,g={};a("body");f.addClass("gammaGrid");var h=b.baseUrl.indexOf("?")>-1?b.baseUrl.substring(0,b.baseUrl.indexOf("?")):b.baseUrl,i=b.pager||function(a,c,e,f){f.skip=c;var g=e>c?"<a href='?"+d(f)+"'>Next&rarr;</a>":"";f.skip=a-b.pageSize-1,f.skip=f.skip<0?0:f.skip;var h=1!==a?"<a href='?"+d(f)+"'>&larr;Previous </a>":"";return 0==c?"<div class='gammaPager'>No Results</div>":"<div class='gammaPager'>"+h+" Showing "+a+" to "+c+" of "+e+g+"</div>"},j=window.location.search,k=b.dataFormatters||{},l=b.columns,m={},n=b.subRowTemplate||null;g.load=function(c){c=c||window.location.search,c=c.replace("?","");var j=e(c);j.take=b.pageSize;var o=b.baseUrl.indexOf("?")>-1?b.baseUrl.substring(b.baseUrl.indexOf("?")):"";if(o){var p=e(o);for(var q in p)j[q]||(j[q]=p[q])}c=d(j);var r=a("<div class='loading' />");f.html(""),f.append(r);var s=h+(h.indexOf("?")>-1?"&"+c:"?"+c);a.ajax(s,{method:"GET",dataType:"json",cache:!1,success:function(h){b.onData&&b.onData(h),f.html("");var o=h.results;if(l=l||h.columns,g.count=h.count,g.start=h.start,g.end=h.end,b.search){var p="";j.search&&(p=" value='"+decodeURIComponent(j.search)+"'"),a(document).on("click",".gammaSearch .clearText",function(){a(this).parent().find("input").val(""),delete j.search,c=d(j),window.location.search=c,g.load(c)}),f.html("<form class='gammaSearch'><input type='text' name='search'"+p+" placeholder='Search...' class='gammaSearchField'/><span class='clearText'>x</span></form>")}var q=!0;if(b.tableClasses)var r=b.tableClasses;else var r="";for(var s=a("<table class='gammaGridTable table "+r+"'/>"),t=a("<tbody />"),u=a("<div class='table-responsive'></div>"),v=0;v<o.length;v++){o[v].id&&(m[o[v].id]=o[v]);var w="odd";v%2==0&&(w="even");var x=a("<tr class='gammaGridRow "+w+"' />"),y=o[v];if(l=l||y,q){var z=a("<thead />");for(var A in l)if("_id"==A||"id"==A){var B=a("<th id='gammaGridHeader_"+A+"' class='gammaGridColumnHeader'></th>"),C=a("<input type='checkbox' class='gammaSelectAll' />"),D=a("<input type='hidden' value='false' id='globalSelectAll'/>"),E=a("<span class='globalText'>All items on this page are selected. </span>"),F=a("<a class='globalTrigger' href='javascript:void(0)'>Select all "+g.count+" items.</a>");F.click(function(b){b.preventDefault(),"true"===D.val()?g.load():(D.val("true"),a(".gammaId").attr("disabled","disabled"),a(".gammaPager a").hide(),E.text("All "+g.count+" items are selected. "),F.text(""))});var G=a("<th class='gammaSelectAll' colspan='"+Object.keys(l).length+"'/>").append(C).append(E).append(F).append(D),H=a("<tr class='gammaSelectAllRow'/>").append(G);H.hide(),z.append(H),C.change(function(){var b=a(this),c=a(".gammaId");c.prop("checked",b.prop("checked")),this.checked?a("tr.gammaGridRow",s).addClass("selected"):a("tr.gammaGridRow",s).removeClass("selected"),this.checked?(E.text(c.length+" items on this page are selected."),H.show()):(H.hide(),D.val("false"),c.removeAttr("disabled"),a(".gammaPager a").show())}),B.append(C),x.append(B)}else{var I=null==l[A]?!1:l[A].sort?l[A].sort:!1;I!==!1&&(I&=h.sort!==A);var J=null===l[A]?A:l[A].title||A;I&&(J=a("<a class='gammaSort' href='?sort="+encodeURIComponent(A)+"'>"+J+"</a>"),J.click(function(){var a=this.href.substring(this.href.lastIndexOf("?")),c=e(a);return j.sort=c.sort,j.skip=0,j.take=b.pageSize,g.load(d(j)),!1}));var K=a("<th id='gammaGridHeader_"+A+"' class='gammaGridColumnHeader' ></th>");A==h.sort&&K.addClass("currentSort"),K.append(J),x.append(K)}z.append(x),s.append(z),q=!1,x=a("<tr class='gammaGridRow' />")}for(var A in l){var L;if("_id"===A||"id"===A){var M=a("<input type='checkbox' class='gammaId' value='"+y[A]+"' />");M.click(function(){var b=a(this);b.attr("checked")?b.parent().parent().addClass("selected"):b.parent().parent().removeClass("selected")}),L=a("<td class='gammaGridColumnData' ></td>"),L.append(M)}else{var N=k[A]?k[A](y[A],y):y[A];if(N||(N=""),l[A].isLink){var O=l[A].href;O.match(/{{\s*[\w\.]+\s*}}/g).map(function(a){var b=a.substring(2,a.length-2),c=y[b];O=O.replace(a,c)}),L=a("<td class='gammaGridColumnData' ><a href='"+O+"'>"+N+"</a></td>")}else l[A].template&&("undefined"==typeof Mustache?console.error("Mustache is required in order to use the template option"):N=Mustache.render(l[A].template,y)),L=a("<td class='gammaGridColumnData' >"+N+"</td>")}A==h.sort&&L.addClass("currentSort"),y.cssClass&&x.addClass(y.cssClass),x.append(L)}if(t.append(x),n)if("undefined"==typeof Mustache)console.error("Mustache is required in order to use the subRowTemplate option");else{t.append(a("<tr class='gammaGridSpacerRow' style='display: none;' />"));var P=Mustache.render(n,y);L=a("<td colspan='"+Object.keys(y).length+"'>"+P+"</tr>"),x=a("<tr class='gammaGridSubRow hidden' />"),x.append(L),t.append(x)}}s.append(t),u.append(s),f.append(u),f.append(i(h.start,h.end,h.count,j)),a(".gammaSearch").submit(function(){return window.location.search="search="+encodeURIComponent(a(".gammaSearchField").val()),!1});var Q=a("<div class='actionCollection' />"),D=a("#globalSelectAll");b.actions&&a.each(b.actions,function(b,c){var d=a("<input id='gamma_btn_"+b+"' type='button' value='"+b+"' />");Q.append(d),d.click(function(){var b=[],d="true"===D.val()?"*":a(".gammaId:checked",f).map(function(){return b.push(m[this.value]),this.value});c.call(g,d,b)})}),f.prepend(Q),b.afterLoad&&b.afterLoad.call(g)},error:function(a){console.error("An error occurred during api call",a)}})},g.load(j)}}(jQuery);